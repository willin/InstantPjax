/* Instantipjax 1.0.0 | (C) 2015-2015 Willin Wang | https://github.com/willin/instantipjax */
(function(d){d.support.ipjax=window.history&&window.history.pushState&&window.history.replaceState&&!navigator.userAgent.match(/((iPod|iPhone|iPad).+\bOS\s+[1-4]\D|WebApps\/.+CFNetwork)/);d.support.storage=!!window.localStorage;var e={isPreloading:!1,stack:{},toInt:function(a){return parseInt(a)},getTime:function(){return 1*new Date},getRealUrl:function(a){a=(a||"").replace(/\#.*?$/,"");return a=a.replace("?ipjax=true&","?").replace("?ipjax=true","").replace("&ipjax=true","")},getUrlHash:function(a){return a.replace(/^[^\#]*(?:\#(.*?))?$/,
"$1")},getLocalKey:function(a){return"ipjax:"+e.getRealUrl(a).replace(window.location.origin,"")},removeAllCache:function(){if(d.support.storage)for(var a in localStorage)"ipjax"===(a.split(":")||[""])[0]&&delete localStorage[a]},getCache:function(a,b,c){a=e.getLocalKey(a);var g;b=e.toInt(b);if(a in e.stack){c=e.stack[a];g=e.getTime();if(c.time+1E3*b>g)return c;delete e.stack[a]}else if(c&&d.support.storage&&(c=localStorage.getItem(a))){c=JSON.parse(c);g=e.toInt(c.time);if(g+1E3*b>e.getTime())return c;
localStorage.removeItem(a)}return null},setCache:function(a,b,c,g){var k=e.getTime();a=e.getLocalKey(a);e.stack[a]={data:b,title:c,time:k};g&&d.support.storage&&localStorage.setItem(a,JSON.stringify(e.stack[a]))},removeCache:function(a){a=e.getRealUrl(a||location.href);a=e.getLocalKey(a);delete e.stack[a];d.support.storage&&localStorage.removeItem(a)}},l,n=function(a,f,c){c=d.extend({selector:a,container:f},b.defaultOptions,c);if(!c.container||!c.selector)throw Error("selector & container options must be set");
c.delay&&(d("body").delegate(c.selector,"mouseenter",function(a){var f=d(this),h=f.attr("href");l=setTimeout(function(){if("function"===typeof c.filter&&!0===c.filter.call(this,h,this)||h===location.href)return!0;if(e.getRealUrl(h)==e.getRealUrl(location.href)){var m=e.getUrlHash(h);m&&(location.hash=m);return!0}a.preventDefault();c=d.extend(!0,c,{url:h,element:f,title:"",push:!0,eventType:a.type});e.isPreloading=!0;b(c)},c.delay)}),d("body").delegate(c.selector,"mouseleave",function(){b.cancel()}));
d("body").delegate(c.selector,"click",function(a){if(1<a.which||a.metaKey)return!0;var f=d(this).attr("href");if("function"===typeof c.filter&&!0===c.filter.call(this,f,this)||f===location.href)return!0;if(e.getRealUrl(f)==e.getRealUrl(location.href)){if(a=e.getUrlHash(f))location.hash=a,c.callback&&c.callback.call(this,{type:"hash"});return!0}a.preventDefault();c=d.extend(!0,c,{url:f,element:this,title:"",push:!0,eventType:a.type});b(c)})},b=function(a){a=d.extend({},b.defaultOptions,a);var f,c=
d(a.container);a.oldUrl=a.url;a.url=e.getRealUrl(a.url);d(a.element).length&&(f=e.toInt(d(a.element).attr("data-ipjax-cache")))&&(a.cache=f);!0===a.cache&&(a.cache=86400);a.cache=e.toInt(a.cache);0===a.cache&&e.removeAllCache();a.showFn||(a.showFn=function(d,f,e){d=d.replace(/<(.*?)data-no-ipjax(.*?)>([\s\S]*?)<\/(.*?)>/g,"");b.showFn(a.show,c,d,f,e)});"GET"!==a.type&&(a.timeout=0);b.options=a;b.options.success=b.success;if(a.cache&&(f=e.getCache(a.url,a.cache,a.storage)))return a.beforeSend(),a.title=
f.title,b.success(f.data,!0),a.complete(),!0;b.xhr&&4>b.xhr.readyState&&(b.xhr.onreadystatechange=d.noop,b.xhr.abort());b.xhr=d.ajax(b.options)};b.defaultOptions={timeout:2E3,element:null,cache:604800,storage:!0,delay:300,url:"",push:!0,show:"fade",title:"",titleSuffix:"",type:"GET",data:{ipjax:!0},dataType:"html",callback:null,beforeSend:function(a){d(b.options.container).trigger("ipjax.start",[a,b.options]);a&&a.setRequestHeader("X-IPJAX",!0)},error:function(a,d){b.options.callback&&b.options.callback.call(b.options.element,
{type:"error"});"cancel"!==d&&(location.href=b.options.url)},complete:function(a){d(b.options.container).trigger("ipjax.end",[a,b.options])}};b.showFx={_default:function(a,b,c){this.html(a);b&&b.call(this,a,c)},fade:function(a,b,c){var d=this;c?(d.html(a),b&&b.call(d,a,c)):this.fadeOut(500,function(){d.html(a).fadeIn(500,function(){b&&b.call(d,a,c)})})}};b.showFn=function(a,e,c,g,k){var h=null;"function"===typeof a?h=a:(a in b.showFx||(a="_default"),h=b.showFx[a]);h&&h.call(e,c,function(){var a=location.hash;
""!=a?(location.href=a,/Firefox/.test(navigator.userAgent)&&history.replaceState(d.extend({},b.state,{url:null}),document.title)):window.scrollTo(0,0);g&&g.call(this,c,k)},k)};b.success=function(a,f){!0!==f&&(f=!1);var c="";if("object"===typeof a)c=a.title||"";else{b.html&&(a=d(a).find(b.html).html());if(-1!=(a||"").indexOf("<html"))return b.options.callback&&b.options.callback.call(b.options.element,{type:"error"}),location.href=b.options.url,!1;c=b.options.title||"";b.options.element&&(c=d(b.options.element),
c=c.attr("title")||c.text());var g=a.match(/<title>(.*?)<\/title>/);g&&(c=g[1])}c&&-1==c.indexOf(b.options.titleSuffix)&&(c+=b.options.titleSuffix);e.isPreloading?e.isPreloading=!1:(document.title=c,b.state={container:b.options.container,timeout:b.options.timeout,cache:b.options.cache,storage:b.options.storage,show:b.options.show,title:c,url:b.options.oldUrl},g=d.param(b.options.data),""!=g&&(b.state.url=b.options.url+(/\?/.test(b.options.url)?"&":"?")+g),b.options.push?(b.active||(history.replaceState(d.extend({},
b.state,{url:null}),document.title),b.active=!0),history.pushState(b.state,document.title,b.options.oldUrl)):!1===b.options.push&&history.replaceState(b.state,document.title,b.options.oldUrl),b.options.showFn&&b.options.showFn(a,function(){b.options.callback&&b.options.callback.call(b.options.element,{type:f?"cache":"success"})},f));b.options.cache&&!f&&e.setCache(b.options.url,a,c,b.options.storage)};b.cancel=function(){l&&clearTimeout(l);b.xhr&&b.xhr.abort("cancel");e.isPreloading&&(d(b.options.container).trigger("ipjax.cancel",
[b.options]),e.isPreloading=!1)};var p="state"in window.history,q=location.href;d(window).bind("popstate",function(a){var e=!p&&location.href==q;p=!0;e||(a=a.state)&&a.container&&(d(a.container).length?b({url:a.url||location.href,container:a.container,push:null,timeout:a.timeout,cache:a.cache,storage:a.storage,title:a.title,element:null}):window.location=location.href)});d.support.ipjax||(n=function(){return!0},b=function(a){a&&a.url&&(location.href=a.url)});d.fn.ipjax=n;d.ipjax=b;d.ipjax.util=e;
0>d.inArray("state",d.event.props)&&d.event.props.push("state")})($);
