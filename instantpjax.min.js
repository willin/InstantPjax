/* Instantipjax 1.0.4 | (C) 2015-2015 Willin Wang | https://github.com/willin/instantipjax */
(function(d){d.support.ipjax=window.history&&window.history.pushState&&window.history.replaceState&&!navigator.userAgent.match(/((iPod|iPhone|iPad).+\bOS\s+[1-4]\D|WebApps\/.+CFNetwork)/);d.support.storage=!!window.localStorage;var e={isPreloading:!1,prevKey:"",stack:{},toInt:function(a){return parseInt(a)},getTime:function(){return 1*new Date},getRealUrl:function(a){a=(a||"").replace(/\#.*?$/,"");return a=a.replace("?ipjax=true&","?").replace("?ipjax=true","").replace("&ipjax=true","")},getUrlHash:function(a){return a.replace(/^[^\#]*(?:\#(.*?))?$/,
"$1")},getLocalKey:function(a){return"ipjax:"+e.getRealUrl(a).replace(window.location.origin,"")},removeAllCache:function(){if(d.support.storage)for(var a in localStorage)"ipjax"===(a.split(":")||[""])[0]&&delete localStorage[a]},getCache:function(a,b,c){a=e.getLocalKey(a);var h;b=e.toInt(b);if(a in e.stack){c=e.stack[a];h=e.getTime();if(c.time+1E3*b>h)return c;delete e.stack[a]}else if(c&&d.support.storage&&(c=localStorage.getItem(a))){c=JSON.parse(c);h=e.toInt(c.time);if(h+1E3*b>e.getTime())return c;
localStorage.removeItem(a)}return null},setCache:function(a,b,c,h){var l=e.getTime();a=e.getLocalKey(a);e.stack[a]={data:b,title:c,time:l};h&&d.support.storage&&localStorage.setItem(a,JSON.stringify(e.stack[a]))},removeCache:function(a){a=e.getRealUrl(a||location.href);a=e.getLocalKey(a);delete e.stack[a];d.support.storage&&localStorage.removeItem(a)}},m,n=function(a,f,c){c=d.extend({selector:a,container:f},b.defaultOptions,c);if(!c.container||!c.selector)throw Error("selector & container options must be set");
c.delay&&(d("body").delegate(c.selector,"mouseenter",function(a){var f=d(this),g=f.attr("href");m=setTimeout(function(){if("function"===typeof c.filter&&!0===c.filter.call(this,g,this)||g===location.href||0===g.indexOf("http")&&-1===g.indexOf(location.origin))return!0;var k=(g||"").toLowerCase().split("."),k=k[k.length-1];if(-1!==d.inArray(k,"png jpg gif zip rar 7z exe doc docx pdf ppt pptx xls xlsx".split(" ")))return!0;if(e.getRealUrl(g)==e.getRealUrl(location.href)){if(k=e.getUrlHash(g))location.hash=
k;return!0}a.preventDefault();c=d.extend(!0,c,{url:g,element:f,title:"",push:!0,eventType:a.type});e.isPreloading=!0;b(c)},c.delay)}),d("body").delegate(c.selector,"mouseleave",function(){b.cancel()}));d("body").delegate(c.selector,"click",function(a){if(1<a.which||a.metaKey)return!0;var f=d(this).attr("href");if("function"===typeof c.filter&&!0===c.filter.call(this,f,this)||f===location.href||0===f.indexOf("http")&&-1===f.indexOf(location.origin))return!0;var g=(f||"").toLowerCase().split("."),g=
g[g.length-1];if(-1!==d.inArray(g,"png jpg gif zip rar 7z exe doc docx pdf ppt pptx xls xlsx".split(" ")))return!0;if(e.getRealUrl(f)==e.getRealUrl(location.href)){if(a=e.getUrlHash(f))location.hash=a,c.callback&&c.callback.call(this,{type:"hash"});return!0}a.preventDefault();c=d.extend(!0,c,{url:f,element:this,title:"",push:!0,eventType:a.type});b(c)})},b=function(a){a=d.extend({},b.defaultOptions,a);var f,c=d(a.container);a.oldUrl=a.url;a.url=e.getRealUrl(a.url);d(a.element).length&&(f=e.toInt(d(a.element).attr("data-ipjax-cache")))&&
(a.cache=f);!0===a.cache&&(a.cache=86400);a.cache=e.toInt(a.cache);0===a.cache&&e.removeAllCache();a.showFn||(a.showFn=function(d,f,e){d=d.replace(/<(.*?)data-no-ipjax(.*?)>([\s\S]*?)<\/(.*?)>/g,"");b.showFn(a.show,c,d,f,e)});"GET"!==a.type&&(a.timeout=0);b.options=a;b.options.success=b.success;if(a.cache&&(!a.cacheIgnore||-1===d.inArray(e.getLocalKey(a.url).replace(/^ipjax:(.*?)$/,"$1"),a.cacheIgnore))&&(f=e.getCache(a.url,a.cache,a.storage)))return"click"===a.eventType?(a.title=f.title,b.success(f.data,
!0)):e.getLocalKey(a.url)!==e.prevKey?(d(b.options.container).trigger("ipjax.cached",[b.options]),a.title=f.title,b.success(f.data,!0)):e.isPreloading=!1,!0;b.xhr&&4>b.xhr.readyState&&(b.xhr.onreadystatechange=d.noop,b.xhr.abort());b.xhr=d.ajax(b.options)};b.defaultOptions={timeout:1E4,element:null,cache:172800,cacheIgnore:!1,storage:!0,delay:300,url:"",push:!0,show:"fade",title:"",titleSuffix:"",type:"GET",data:{ipjax:!0},dataType:"html",filter:null,callback:null,beforeSend:function(a){d(b.options.container).trigger("ipjax.start",
[a,b.options]);a&&a.setRequestHeader("X-IPJAX",!0)},error:function(a,d){b.options.callback&&b.options.callback.call(b.options.element,{type:"error"});"cancel"!==d&&(location.href=b.options.url);console.log(a)},complete:function(a){d(b.options.container).trigger("ipjax.end",[a,b.options])}};b.showFx={_default:function(a,b,c){this.html(a);b&&b.call(this,a,c)},fade:function(a,b,c){var d=this;c?(d.html(a),b&&b.call(d,a,c)):this.fadeOut(500,function(){d.html(a).fadeIn(500,function(){b&&b.call(d,a,c)})})}};
b.showFn=function(a,e,c,h,l){var g=null;"function"===typeof a?g=a:(a in b.showFx||(a="_default"),g=b.showFx[a]);g&&g.call(e,c,function(){var a=location.hash;""!=a?(location.href=a,/Firefox/.test(navigator.userAgent)&&history.replaceState(d.extend({},b.state,{url:null}),document.title)):window.scrollTo(0,0);h&&h.call(this,c,l)},l)};b.success=function(a,f){!0!==f&&(f=!1);var c="";if("object"===typeof a)c=a.title||"";else if(a){c=b.options.title||"";b.options.element&&(c=d(b.options.element),c=c.attr("title")||
c.text());var h=a.match(/<title>(.*?)<\/title>/);h&&(c=h[1]);-1!==a.indexOf("<html")&&(a=d(a).find(b.options.container).html())}else return b.options.callback&&b.options.callback.call(b.options.element,{type:"error"}),location.href=b.options.url,!1;c&&-1==c.indexOf(b.options.titleSuffix)&&(c+=b.options.titleSuffix);e.isPreloading?e.isPreloading=!1:(document.title=c,b.state={container:b.options.container,timeout:b.options.timeout,cache:b.options.cache,storage:b.options.storage,show:b.options.show,
title:c,url:b.options.oldUrl},h=d.param(b.options.data),""!=h&&(b.state.url=b.options.url+(/\?/.test(b.options.url)?"&":"?")+h),b.options.push?(b.active||(history.replaceState(d.extend({},b.state,{url:null}),document.title),b.active=!0),history.pushState(b.state,document.title,b.options.oldUrl)):!1===b.options.push&&history.replaceState(b.state,document.title,b.options.oldUrl),b.options.showFn&&b.options.showFn(a,function(){b.options.callback&&b.options.callback.call(b.options.element,{type:f?"cache":
"success"})},f));e.prevKey=e.getLocalKey(b.options.url);b.options.cache&&!f&&e.setCache(b.options.url,a,c,b.options.storage)};b.cancel=function(){m&&clearTimeout(m);b.xhr&&b.xhr.abort("cancel");e.isPreloading&&(d(b.options.container).trigger("ipjax.cancel",[b.options]),e.isPreloading=!1)};var p="state"in window.history,q=location.href;d(window).bind("popstate",function(a){var e=!p&&location.href==q;p=!0;e||(a=a.state)&&a.container&&(d(a.container).length?b({url:a.url||location.href,container:a.container,
push:null,timeout:a.timeout,cache:a.cache,storage:a.storage,title:a.title,element:null,eventType:"click"}):window.location=location.href)});d.support.ipjax||(n=function(){return!0},b=function(a){a&&a.url&&(location.href=a.url)});d.fn.ipjax=n;d.ipjax=b;d.ipjax.util=e;0>d.inArray("state",d.event.props)&&d.event.props.push("state")})(jQuery);
