/* Instantipjax 1.0.2 | (C) 2015-2015 Willin Wang | https://github.com/willin/instantipjax */
(function(e){e.support.ipjax=window.history&&window.history.pushState&&window.history.replaceState&&!navigator.userAgent.match(/((iPod|iPhone|iPad).+\bOS\s+[1-4]\D|WebApps\/.+CFNetwork)/);e.support.storage=!!window.localStorage;var d={isPreloading:!1,prevKey:"",stack:{},toInt:function(a){return parseInt(a)},getTime:function(){return 1*new Date},getRealUrl:function(a){a=(a||"").replace(/\#.*?$/,"");return a=a.replace("?ipjax=true&","?").replace("?ipjax=true","").replace("&ipjax=true","")},getUrlHash:function(a){return a.replace(/^[^\#]*(?:\#(.*?))?$/,
"$1")},getLocalKey:function(a){return"ipjax:"+d.getRealUrl(a).replace(window.location.origin,"")},removeAllCache:function(){if(e.support.storage)for(var a in localStorage)"ipjax"===(a.split(":")||[""])[0]&&delete localStorage[a]},getCache:function(a,b,c){a=d.getLocalKey(a);var g;b=d.toInt(b);if(a in d.stack){c=d.stack[a];g=d.getTime();if(c.time+1E3*b>g)return c;delete d.stack[a]}else if(c&&e.support.storage&&(c=localStorage.getItem(a))){c=JSON.parse(c);g=d.toInt(c.time);if(g+1E3*b>d.getTime())return c;
localStorage.removeItem(a)}return null},setCache:function(a,b,c,g){var k=d.getTime();a=d.getLocalKey(a);d.stack[a]={data:b,title:c,time:k};g&&e.support.storage&&localStorage.setItem(a,JSON.stringify(d.stack[a]))},removeCache:function(a){a=d.getRealUrl(a||location.href);a=d.getLocalKey(a);delete d.stack[a];e.support.storage&&localStorage.removeItem(a)}},l,n=function(a,f,c){c=e.extend({selector:a,container:f},b.defaultOptions,c);if(!c.container||!c.selector)throw Error("selector & container options must be set");
c.delay&&(e("body").delegate(c.selector,"mouseenter",function(a){var f=e(this),h=f.attr("href");l=setTimeout(function(){if("function"===typeof c.filter&&!0===c.filter.call(this,h,this)||h===location.href||0===h.indexOf("http")&&-1===h.indexOf(location.origin))return!0;if(d.getRealUrl(h)==d.getRealUrl(location.href)){var m=d.getUrlHash(h);m&&(location.hash=m);return!0}a.preventDefault();c=e.extend(!0,c,{url:h,element:f,title:"",push:!0,eventType:a.type});d.isPreloading=!0;b(c)},c.delay)}),e("body").delegate(c.selector,
"mouseleave",function(){b.cancel()}));e("body").delegate(c.selector,"click",function(a){if(1<a.which||a.metaKey)return!0;var f=e(this).attr("href");if("function"===typeof c.filter&&!0===c.filter.call(this,f,this)||f===location.href||0===f.indexOf("http")&&-1===f.indexOf(location.origin))return!0;if(d.getRealUrl(f)==d.getRealUrl(location.href)){if(a=d.getUrlHash(f))location.hash=a,c.callback&&c.callback.call(this,{type:"hash"});return!0}a.preventDefault();c=e.extend(!0,c,{url:f,element:this,title:"",
push:!0,eventType:a.type});b(c)})},b=function(a){a=e.extend({},b.defaultOptions,a);var f,c=e(a.container);a.oldUrl=a.url;a.url=d.getRealUrl(a.url);e(a.element).length&&(f=d.toInt(e(a.element).attr("data-ipjax-cache")))&&(a.cache=f);!0===a.cache&&(a.cache=86400);a.cache=d.toInt(a.cache);0===a.cache&&d.removeAllCache();a.showFn||(a.showFn=function(f,d,e){f=f.replace(/<(.*?)data-no-ipjax(.*?)>([\s\S]*?)<\/(.*?)>/g,"");b.showFn(a.show,c,f,d,e)});"GET"!==a.type&&(a.timeout=0);b.options=a;b.options.success=
b.success;if(a.cache&&(f=d.getCache(a.url,a.cache,a.storage)))return"click"===a.eventType?(a.title=f.title,b.success(f.data,!0)):d.getLocalKey(a.url)!==d.prevKey?(e(b.options.container).trigger("ipjax.cached",[b.options]),a.title=f.title,b.success(f.data,!0)):d.isPreloading=!1,!0;b.xhr&&4>b.xhr.readyState&&(b.xhr.onreadystatechange=e.noop,b.xhr.abort());b.xhr=e.ajax(b.options)};b.defaultOptions={timeout:2E3,element:null,cache:604800,storage:!0,delay:300,url:"",push:!0,show:"fade",title:"",titleSuffix:"",
type:"GET",data:{ipjax:!0},dataType:"html",callback:null,beforeSend:function(a){e(b.options.container).trigger("ipjax.start",[a,b.options]);a&&a.setRequestHeader("X-IPJAX",!0)},error:function(a,f){b.options.callback&&b.options.callback.call(b.options.element,{type:"error"});"cancel"!==f&&(location.href=b.options.url);console.log(a)},complete:function(a){e(b.options.container).trigger("ipjax.end",[a,b.options])}};b.showFx={_default:function(a,b,c){this.html(a);b&&b.call(this,a,c)},fade:function(a,
b,c){var d=this;c?(d.html(a),b&&b.call(d,a,c)):this.fadeOut(500,function(){d.html(a).fadeIn(500,function(){b&&b.call(d,a,c)})})}};b.showFn=function(a,d,c,g,k){var h=null;"function"===typeof a?h=a:(a in b.showFx||(a="_default"),h=b.showFx[a]);h&&h.call(d,c,function(){var a=location.hash;""!=a?(location.href=a,/Firefox/.test(navigator.userAgent)&&history.replaceState(e.extend({},b.state,{url:null}),document.title)):window.scrollTo(0,0);g&&g.call(this,c,k)},k)};b.success=function(a,f){!0!==f&&(f=!1);
var c="";if("object"===typeof a)c=a.title||"";else if(a){c=b.options.title||"";b.options.element&&(c=e(b.options.element),c=c.attr("title")||c.text());var g=a.match(/<title>(.*?)<\/title>/);g&&(c=g[1]);-1!==a.indexOf("<html")&&(a=e(a).find(b.options.container).html())}else return b.options.callback&&b.options.callback.call(b.options.element,{type:"error"}),location.href=b.options.url,!1;c&&-1==c.indexOf(b.options.titleSuffix)&&(c+=b.options.titleSuffix);d.isPreloading?d.isPreloading=!1:(document.title=
c,b.state={container:b.options.container,timeout:b.options.timeout,cache:b.options.cache,storage:b.options.storage,show:b.options.show,title:c,url:b.options.oldUrl},g=e.param(b.options.data),""!=g&&(b.state.url=b.options.url+(/\?/.test(b.options.url)?"&":"?")+g),b.options.push?(b.active||(history.replaceState(e.extend({},b.state,{url:null}),document.title),b.active=!0),history.pushState(b.state,document.title,b.options.oldUrl)):!1===b.options.push&&history.replaceState(b.state,document.title,b.options.oldUrl),
b.options.showFn&&b.options.showFn(a,function(){b.options.callback&&b.options.callback.call(b.options.element,{type:f?"cache":"success"})},f));d.prevKey=d.getLocalKey(b.options.url);b.options.cache&&!f&&d.setCache(b.options.url,a,c,b.options.storage)};b.cancel=function(){l&&clearTimeout(l);b.xhr&&b.xhr.abort("cancel");d.isPreloading&&(e(b.options.container).trigger("ipjax.cancel",[b.options]),d.isPreloading=!1)};var p="state"in window.history,q=location.href;e(window).bind("popstate",function(a){var d=
!p&&location.href==q;p=!0;d||(a=a.state)&&a.container&&(e(a.container).length?b({url:a.url||location.href,container:a.container,push:null,timeout:a.timeout,cache:a.cache,storage:a.storage,title:a.title,element:null,eventType:"click"}):window.location=location.href)});e.support.ipjax||(n=function(){return!0},b=function(a){a&&a.url&&(location.href=a.url)});e.fn.ipjax=n;e.ipjax=b;e.ipjax.util=d;0>e.inArray("state",e.event.props)&&e.event.props.push("state")})($);
